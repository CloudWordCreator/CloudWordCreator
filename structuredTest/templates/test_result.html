<!DOCTYPE html>
<html lang="ja">
<head>
    {% load static %}
    <link href="{% static 'css/style.css' %}" media="print" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="{% static 'structuredTest/css/test_result_style.css' %}">
    <script src="{% static 'structuredTest/js/test_result_scripts.js' %}"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>テスト</title>
</head>
<body>
    <button id="english-to-japanese-button" class="button">英語→日本語</button>
    <button id="japanese-to-english-button" class="button">日本語→英語</button>
    <button onclick="printContent()" class="button">印刷</button>
    <a href="{% url 'display_data' %}">戻る</a>
    <div class="print-area">
        <!-- 英語->日本語 -->
        <div id="english-to-japanese-content" class="tab">
            <!-- JavaScriptがここにテーブルを生成します -->
        </div>
        <!-- 日本語->英語 -->
        <div id="japanese-to-english-content" class="tab">
            <!-- JavaScriptがここにテーブルを生成します -->
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const data = {{ data|safe }};
            console.log(data);

            // テーブル番号ごとに単語をまとめる
            const positionMap = {};

            data.units.forEach(unit => {
                unit.sub_units.forEach(subUnit => {
                    subUnit.words.forEach(word => {
                        if (!positionMap[word.position]) {
                            positionMap[word.position] = [];
                        }
                        positionMap[word.position].push({
                            english: word.english,
                            japanese: word.japanese,
                            subUnitName: subUnit.name
                        });
                    });
                });
            });

            let tableCounter = 0;
            let currentWrapper = null;

            // positionごとにテーブルを生成
            Object.keys(positionMap).forEach(position => {
                const words = positionMap[position];
                const section = document.createElement('div');
                section.classList.add('table-section');

                const heading = document.createElement('h2');
                heading.textContent = `テーブル番号: ${position}`;
                heading.classList.add('table-heading');
                section.appendChild(heading);

                const subUnitMap = {};
                words.forEach(word => {
                    if (!subUnitMap[word.subUnitName]) {
                        subUnitMap[word.subUnitName] = [];
                    }
                    subUnitMap[word.subUnitName].push(word);
                });

                const table = document.createElement('table');
                table.classList.add('table', 'table-bordered');

                const tbody = document.createElement('tbody');
                Object.keys(subUnitMap).forEach(subUnitName => {
                    const subUnitWords = subUnitMap[subUnitName];

                    const subUnitHeadingRow = document.createElement('tr');
                    const subUnitHeadingCell = document.createElement('td');
                    // 子unitを表示する場所
                    subUnitHeadingCell.colSpan = 2;
                    subUnitHeadingCell.textContent = `${subUnitName}`;
                    subUnitHeadingCell.classList.add('subunit-heading');
                    subUnitHeadingRow.appendChild(subUnitHeadingCell);
                    tbody.appendChild(subUnitHeadingRow);

                    subUnitWords.forEach(word => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${word.english}</td>
                            <td>${word.japanese}</td>
                        `;
                        tbody.appendChild(row);
                    });
                });
                table.appendChild(tbody);
                section.appendChild(table);

                // 表が2個表示されたら、印刷用のcssを読み込む
                if (tableCounter % 2 === 0) {
                    currentWrapper = document.createElement('div');
                    currentWrapper.classList.add('printer-setting');

                    // 新しいleft-columnとright-columnを作成
                    const leftColumn = document.createElement('div');
                    leftColumn.classList.add('column', 'left-column');
                    const rightColumn = document.createElement('div');
                    rightColumn.classList.add('column', 'right-column');

                    currentWrapper.appendChild(leftColumn);
                    currentWrapper.appendChild(rightColumn);

                    // 親要素に追加
                    const parentElement = document.getElementById('english-to-japanese-content');
                    parentElement.appendChild(currentWrapper);
                }

                // テーブルを左右に分けて配置
                // 奇数なら左側、偶数なら右側に表示する
                if (tableCounter % 2 === 0) {
                    currentWrapper.querySelector('.left-column').appendChild(section);
                } else {
                    currentWrapper.querySelector('.right-column').appendChild(section);
                }

                tableCounter++;
            });
        });
    </script>
</body>
</html>